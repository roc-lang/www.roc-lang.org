on:
  pull_request:

name: CI checks

# Cancel job if new one is started
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


# Do not add permissions here! Configure them at the job level!
permissions: {}

jobs:
  ci-checks:
    runs-on: [ubuntu-24.04]
    timeout-minutes: 30
    env:
      FORCE_COLOR: 1
    steps:
      - uses: actions/checkout@v4

      - run: cargo install typos-cli --version 1.34.0

      - name: do spell check with typos-cli 1.34.0
        run: typos

      - uses: roc-lang/setup-roc@39c354a6a838a0089eea9068a0414f49b62c5c08
        with:
          # Note: nightly hashes are not verified because they are updated regularly.
          version: nightly

      - run: roc version

      - run: |
          cd website
          roc check build_website.roc

  test-install-script:
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux
            arch: x86_64
          - os: ubuntu-24.04-arm
            platform: linux
            arch: arm64
          - os: macos-15
            platform: macos
            arch: apple_silicon
          - os: macos-15-intel
            platform: macos
            arch: x86_64
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Test install script (answer no to PATH)
        run: |
          cd website/content/installnew/install_scripts
          bash unix.sh <<< "n"

      - name: Verify installation (no PATH)
        run: |
          cd website/content/installnew/install_scripts
          DIR_NAME="roc_nightly-${{ matrix.platform }}_${{ matrix.arch }}-2025-10-31-8553832"
          if [ ! -d "$DIR_NAME" ]; then
            echo "Error: Installation directory $DIR_NAME not found"
            exit 1
          fi

      - name: Test roc binary (no PATH)
        run: |
          cd website/content/installnew/install_scripts
          DIR_NAME="roc_nightly-${{ matrix.platform }}_${{ matrix.arch }}-2025-10-31-8553832"
          "$DIR_NAME/roc" version

      - name: Clean up for second test
        run: |
          cd website/content/installnew/install_scripts
          rm -rf roc_nightly-*

      - name: Test install script (answer yes to PATH)
        run: |
          cd website/content/installnew/install_scripts
          bash unix.sh <<< "y"

      - name: Verify PATH was updated
        run: |
          # Detect shell profile based on SHELL
          if [ -n "${SHELL:-}" ]; then
            case "$SHELL" in
              */bash) PROFILE="$HOME/.bashrc" ;;
              */zsh)  PROFILE="$HOME/.zshrc" ;;
              */fish) PROFILE="$HOME/.config/fish/config.fish" ;;
              *)      PROFILE="$HOME/.profile" ;;
            esac
          else
            PROFILE="$HOME/.profile"
          fi

          if ! grep -q "roc_nightly-${{ matrix.platform }}_${{ matrix.arch }}-2025-10-31-8553832" "$PROFILE"; then
            echo "Error: PATH not updated in $PROFILE"
            exit 1
          fi
          echo "âœ… PATH successfully updated in $PROFILE"
